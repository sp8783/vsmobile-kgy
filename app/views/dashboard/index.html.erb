<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">ダッシュボード</h1>
    <p class="mt-2 text-sm text-gray-600">ようこそ、<%= current_user.nickname %>さん</p>
    <% if current_user.is_guest %>
      <div class="mt-4 bg-amber-50 border-l-4 border-amber-400 p-4">
        <div class="flex">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-amber-400" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
            </svg>
          </div>
          <div class="ml-3">
            <p class="text-sm text-amber-700">
              <span class="font-medium">ゲストアカウントでログイン中：</span>
              個人戦績などの機能を利用するには、管理者にアカウント発行を依頼してください。
            </p>
          </div>
        </div>
      </div>
    <% elsif @user_total_matches == 0 %>
      <div class="mt-4 bg-blue-50 border-l-4 border-blue-400 p-4">
        <div class="flex">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
            </svg>
          </div>
          <div class="ml-3">
            <p class="text-sm text-blue-700">
              <span class="font-medium">初めての方へ：</span>
              対戦会でイベントが作成されたら、ローテーション表から試合に参加しましょう。試合結果を記録すると、ここに統計情報が表示されます。
            </p>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- 2カラムレイアウト -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- 左カラム（メインコンテンツ） -->
    <div class="lg:col-span-2 space-y-6">

      <!-- 1. リアルタイム待機状況カード（開催中のローテーション表がある場合のみ） -->
      <% if @active_rotation %>
        <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white shadow-lg rounded-lg p-4 sm:p-6" data-controller="rotation-subscriber" data-rotation-subscriber-rotation-id-value="<%= @active_rotation.id %>">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-2">
            <div>
              <h2 class="text-lg sm:text-xl font-bold">🎮 本日のイベント</h2>
              <p class="text-sm text-white text-opacity-90 mt-1"><%= @today_event.name %></p>
            </div>
            <div class="flex items-center space-x-2 flex-wrap gap-y-2">
              <div class="inline-flex items-center px-2 py-1 bg-red-100 border border-red-300 rounded-full">
                <span class="w-2 h-2 bg-red-500 rounded-full mr-1 animate-pulse"></span>
                <span class="text-xs font-medium text-red-800">リアルタイム更新中</span>
              </div>
              <span class="bg-white text-purple-600 px-2 sm:px-3 py-1 rounded-full text-xs sm:text-sm font-semibold">
                <%= @today_event.held_on.strftime('%Y/%m/%d') %>
              </span>
            </div>
          </div>

          <!-- アクティブなローテーション -->
          <div class="bg-white text-gray-900 rounded-lg p-4 mb-4 shadow-sm">
            <div class="text-sm font-semibold mb-2 text-purple-700">🔴 アクティブなローテーション</div>
            <div class="text-2xl font-bold text-gray-900"><%= @active_rotation.name %></div>
            <div class="text-sm mt-1 text-gray-600">
              進捗: <%= @rotation_current_match_index + 1 %> / <%= @rotation_total_matches %> 試合
            </div>
          </div>

          <!-- 現在の試合 -->
          <% if @current_rotation_match %>
            <div class="bg-white text-gray-900 rounded-lg p-3 sm:p-4 mb-4 shadow-sm">
              <div class="text-sm font-semibold mb-2 sm:mb-3 text-gray-700">📍 現在の試合</div>
              <div class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2 sm:mb-3 text-center">第<%= @rotation_current_match_index + 1 %>試合</div>
              <div class="grid grid-cols-3 gap-2 sm:gap-3 text-xs sm:text-sm">
                <div class="bg-gray-50 rounded p-2">
                  <div class="text-xs text-gray-500 mb-1">チーム1</div>
                  <div class="flex flex-wrap items-center">
                    <span class="font-bold text-red-600"><%= @current_rotation_match.team1_player1.nickname %></span>
                    <span class="ml-1 sm:ml-2 px-1 sm:px-2 py-0.5 bg-red-100 text-red-700 rounded text-xs font-semibold">配信台</span>
                  </div>
                  <div class="text-gray-700 mt-1"><%= @current_rotation_match.team1_player2.nickname %></div>
                </div>
                <div class="flex items-center justify-center">
                  <span class="text-lg sm:text-xl font-bold text-gray-400">VS</span>
                </div>
                <div class="bg-gray-50 rounded p-2">
                  <div class="text-xs text-gray-500 mb-1">チーム2</div>
                  <div class="font-medium text-gray-900"><%= @current_rotation_match.team2_player1.nickname %></div>
                  <div class="text-gray-700 mt-1"><%= @current_rotation_match.team2_player2.nickname %></div>
                </div>
              </div>
            </div>
          <% end %>

          <% if @user_next_rotation_match %>
            <!-- あなたの次の出番 -->
            <%
              # 緊急度による色とアニメーションの設定
              if @matches_until_user_turn == 0
                border_color = "border-red-500"
                badge_color = "bg-red-50 text-red-600 border-red-200"
                urgency_message = "🔔 今です！席についてください！"
                animate_class = "animate-pulse"
              elsif @matches_until_user_turn == 1
                border_color = "border-indigo-500"
                badge_color = "bg-indigo-100 text-indigo-600 border-indigo-300"
                urgency_message = "⚠️ 次の試合です！準備してください！"
                animate_class = ""
              else
                # 2試合後以降は全て同じ薄いインディゴで統一
                border_color = "border-indigo-400"
                badge_color = "bg-indigo-50 text-indigo-600 border-indigo-200"
                if @matches_until_user_turn == 2
                  urgency_message = "⏳ あと2試合後です"
                else
                  urgency_message = "あと#{@matches_until_user_turn}試合後"
                end
                animate_class = ""
              end
            %>
            <div class="bg-white text-gray-900 rounded-lg border-t-4 <%= border_color %> shadow-sm p-4 mb-4 <%= animate_class %>">
              <div class="text-sm font-semibold mb-3 text-gray-700">⏰ あなたの次の出番</div>

              <div class="mb-4">
                <div class="text-3xl font-bold text-gray-900 mb-3 text-center">第<%= @user_next_rotation_match.match_index + 1 %>試合</div>
                <div class="px-4 py-2 rounded-lg text-sm font-bold border-2 <%= badge_color %> text-center">
                  <%= urgency_message %>
                </div>
              </div>

              <% if @is_streaming %>
                <div class="bg-red-50 border-2 border-red-200 rounded-lg p-2 mb-3">
                  <div class="text-center">
                    <div class="text-sm font-bold text-red-600">📹 あなたが配信台担当です（左側の席）</div>
                  </div>
                </div>
              <% end %>

              <div class="bg-gray-50 rounded-lg p-3">
                <div class="text-xs text-gray-500 mb-2 font-semibold">対戦情報</div>
                <div class="space-y-2 text-sm">
                  <div class="flex items-center justify-between">
                    <span class="text-gray-600">🤝 パートナー</span>
                    <span class="font-bold text-gray-900 <%= @is_streaming && @user_partner.id == @user_next_rotation_match.team1_player1_id ? 'text-red-600' : '' %>">
                      <%= @user_partner.nickname %>
                      <% if @is_streaming && @user_partner.id == @user_next_rotation_match.team1_player1_id %>
                        <span class="ml-1 px-2 py-0.5 bg-red-500 text-white rounded text-xs">配信台</span>
                      <% end %>
                    </span>
                  </div>
                  <div class="border-t border-gray-200 pt-2"></div>
                  <div class="flex items-center justify-between">
                    <span class="text-gray-600">⚔️ 対戦相手</span>
                    <span class="font-medium text-gray-900"><%= @opponent_players.map(&:nickname).join(' & ') %></span>
                  </div>
                </div>
              </div>
            </div>

            <%= link_to "📊 ローテーション表全体を見る", rotation_path(@active_rotation), class: "block w-full bg-gray-600 text-white text-center font-semibold py-3 px-4 rounded hover:bg-gray-700 transition" %>
          <% else %>
            <div class="bg-white text-gray-900 rounded-lg p-4 text-center shadow-sm">
              <div class="text-4xl mb-3">🎉</div>
              <p class="text-gray-900 font-semibold mb-2">お疲れ様でした！</p>
              <p class="text-gray-600 text-sm mb-3">このローテーションでの出番は終了しました</p>
              <%= link_to "ローテーション表を見る", rotation_path(@active_rotation), class: "inline-block bg-gray-600 text-white font-semibold py-2 px-4 rounded hover:bg-gray-700 transition" %>
            </div>
          <% end %>
        </div>
      <% elsif @today_event %>
        <!-- ローテーション表がない場合の表示 -->
        <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white shadow-lg rounded-lg p-6">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h2 class="text-xl font-bold">🎮 本日のイベント</h2>
              <p class="text-sm text-white text-opacity-90 mt-1"><%= @today_event.name %></p>
            </div>
            <span class="bg-white text-purple-600 px-3 py-1 rounded-full text-sm font-semibold">
              <%= @today_event.held_on.strftime('%Y/%m/%d') %>
            </span>
          </div>
          <div class="bg-white text-gray-900 rounded-lg p-4 text-center shadow-sm">
            <p class="text-purple-700 mb-3">アクティブなローテーションがありません</p>
            <% if current_user.is_admin? %>
              <%= link_to "ローテーション作成", new_event_rotation_path(@today_event), class: "inline-block bg-indigo-600 text-white font-semibold py-2 px-4 rounded hover:bg-indigo-700 transition shadow-sm" %>
            <% else %>
              <p class="text-sm text-gray-500">管理者がローテーションを作成するまでお待ちください</p>
            <% end %>
          </div>
        </div>
      <% end %>

      <% if current_user.is_guest %>
        <!-- ゲスト用: 個人戦績の代わりに案内を表示 -->
        <div class="bg-white shadow rounded-lg p-6">
          <div class="text-center py-8">
            <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            <h3 class="mt-4 text-lg font-semibold text-gray-900">個人戦績機能</h3>
            <p class="mt-2 text-sm text-gray-500">アカウントを発行してもらうと、以下の機能が利用できます：</p>
            <ul class="mt-4 text-sm text-gray-600 space-y-2">
              <li>調子メーター（直近の勝敗傾向）</li>
              <li>イベントごとの戦績比較</li>
              <li>最近の対戦履歴</li>
              <li>対面相性マトリクス</li>
              <li>ベストパートナー分析</li>
              <li>使用機体の統計</li>
            </ul>
            <p class="mt-6 text-xs text-gray-400">管理者にアカウント発行を依頼してください</p>
          </div>
        </div>
      <% else %>
      <!-- 2. 調子メーター -->
      <div class="bg-white shadow rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-gray-900">📊 調子メーター</h2>
          <span class="text-xs text-gray-500" title="直近の試合結果から、現在の調子を確認できます">ℹ️ 最近の調子</span>
        </div>

        <div class="mb-4">
          <div class="text-sm text-gray-600 mb-3">直近5試合</div>
          <div class="flex items-center space-x-3">
            <% @recent_5_results.each_with_index do |result, index| %>
              <% is_latest = (index == 0) %>
              <div class="flex flex-col items-center">
                <% if is_latest %>
                  <span class="text-xs text-gray-500 mb-1">最新</span>
                <% else %>
                  <span class="text-xs mb-1" style="visibility: hidden;">-</span>
                <% end %>
                <span class="px-2 py-1 text-xs font-bold rounded <%= result ? 'bg-blue-600 text-white' : 'bg-red-600 text-white' %>">
                  <%= result ? 'WIN' : 'LOSE' %>
                </span>
              </div>
              <% if index < @recent_5_results.size - 1 %>
                <div class="border-l-2 border-gray-300 h-6 mt-4"></div>
              <% end %>
            <% end %>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <div class="text-sm text-gray-600">直近10試合勝率</div>
            <div class="text-2xl font-bold text-blue-600"><%= @recent_10_win_rate %>%</div>
            <div class="text-xs <%= @recent_10_diff >= 0 ? 'text-blue-600' : 'text-red-600' %>">
              全体比 <%= @recent_10_diff >= 0 ? '+' : '' %><%= @recent_10_diff.round(1) %>%
            </div>
          </div>
          <div>
            <div class="text-sm text-gray-600">現在の連勝/連敗</div>
            <div class="text-2xl font-bold <%= @streak_type == 'win' ? 'text-blue-600' : 'text-red-600' %>">
              <%= @current_streak %><%= @streak_type == 'win' ? '連勝' : '連敗' %>
            </div>
          </div>
        </div>

        <% if @streak_type == 'win' && @current_streak >= 3 %>
          <div class="bg-blue-50 border border-blue-200 rounded p-3 text-sm text-blue-800">
            🔥 絶好調！この調子で勝ち続けましょう！
          </div>
        <% elsif @streak_type == 'lose' && @current_streak >= 3 %>
          <div class="bg-red-50 border border-red-200 rounded p-3 text-sm text-red-800">
            💪 落ち着いて！次は勝てます！
          </div>
        <% end %>
      </div>

      <!-- 3. 対戦会クイック比較 -->
      <div class="bg-white shadow rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-gray-900">📈 対戦会クイック比較</h2>
          <span class="text-xs text-gray-500" title="直近のイベントでの成績を比較できます">ℹ️ 最近3回</span>
        </div>
        <% events_with_matches = @event_comparison.select { |ec| ec[:total] > 0 } %>
        <% if events_with_matches.any? %>
          <div class="space-y-3">
            <% events_with_matches.each do |ec| %>
              <div class="border rounded p-3 <%= ec[:is_today] ? 'bg-blue-50 border-blue-300' : 'border-gray-200' %>">
                <div class="flex items-center justify-between mb-2">
                  <div>
                    <div class="font-semibold text-gray-900"><%= ec[:event].name %></div>
                    <div class="text-xs text-gray-500"><%= ec[:event].held_on.strftime('%Y年%m月%d日') %></div>
                  </div>
                  <% if ec[:is_today] %>
                    <span class="bg-blue-500 text-white px-2 py-1 rounded text-xs font-semibold">開催中</span>
                  <% else %>
                    <span class="bg-gray-500 text-white px-2 py-1 rounded text-xs font-semibold">完了</span>
                  <% end %>
                </div>
                <div class="flex items-center space-x-4 text-sm">
                  <span class="text-gray-600">戦績: <%= ec[:wins] %>勝<%= ec[:losses] %>敗</span>
                  <span class="font-semibold text-blue-600">勝率: <%= ec[:win_rate] %>%</span>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="py-8 text-center">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            <p class="mt-2 text-sm text-gray-500">まだイベントの対戦記録がありません</p>
            <p class="mt-1 text-xs text-gray-400">イベントに参加して試合をすると、ここにイベントごとの成績が表示されます</p>
          </div>
        <% end %>
      </div>

      <!-- 4. 最近の対戦（5件） -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-5 border-b border-gray-200">
          <h2 class="text-lg font-bold text-gray-900">🕐 最近の対戦</h2>
        </div>
        <div class="divide-y divide-gray-200">
          <% if @recent_matches.any? %>
            <% @recent_matches.each do |match| %>
              <%
                # ログインユーザーのチームを特定
                my_player = match.match_players.find { |mp| mp.user_id == viewing_as_user.id }
              %>
              <%= link_to match_path(match), class: "block hover:bg-gray-50 px-6 py-4" do %>
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs text-gray-500"><%= match.played_at.strftime('%Y年%m月%d日') %></span>
                  <% if my_player %>
                    <% is_win = (match.winning_team == my_player.team_number) %>
                    <span class="text-xs font-bold px-2 py-0.5 rounded <%= is_win ? 'bg-blue-600 text-white' : 'bg-red-600 text-white' %>">
                      <%= is_win ? 'WIN' : 'LOSE' %>
                    </span>
                  <% end %>
                </div>
                <div class="text-xs text-gray-500 mb-2"><%= match.event.name %></div>

                <%
                  if my_player
                    my_team = my_player.team_number
                    opponent_team = my_team == 1 ? 2 : 1

                    my_team_players = match.match_players.select { |mp| mp.team_number == my_team }.sort_by(&:position)
                    opponent_players = match.match_players.select { |mp| mp.team_number == opponent_team }.sort_by(&:position)
                %>
                  <div class="grid grid-cols-2 gap-2 text-xs mt-2">
                    <div class="<%= match.winning_team == my_team ? 'bg-blue-50 border-2 border-blue-400' : 'bg-red-50 border-2 border-red-400' %> rounded p-2 relative">
                      <% if match.winning_team == my_team %>
                        <div class="absolute top-1 right-1">
                          <span class="text-xs font-bold px-2 py-0.5 rounded bg-blue-600 text-white">WIN</span>
                        </div>
                      <% else %>
                        <div class="absolute top-1 right-1">
                          <span class="text-xs font-bold px-2 py-0.5 rounded bg-red-600 text-white">LOSE</span>
                        </div>
                      <% end %>
                      <div class="font-semibold text-gray-700 mb-1">自チーム</div>
                      <% my_team_players.each_with_index do |player, index| %>
                        <div class="<%= (my_team == 1 && player.position == 1) ? 'text-red-600 font-bold' : 'text-gray-600' %>">
                          <%= player.user.nickname %> / <%= player.mobile_suit.name %>
                        </div>
                      <% end %>
                    </div>
                    <div class="<%= match.winning_team == opponent_team ? 'bg-blue-50 border-2 border-blue-400' : 'bg-red-50 border-2 border-red-400' %> rounded p-2 relative">
                      <% if match.winning_team == opponent_team %>
                        <div class="absolute top-1 right-1">
                          <span class="text-xs font-bold px-2 py-0.5 rounded bg-blue-600 text-white">WIN</span>
                        </div>
                      <% else %>
                        <div class="absolute top-1 right-1">
                          <span class="text-xs font-bold px-2 py-0.5 rounded bg-red-600 text-white">LOSE</span>
                        </div>
                      <% end %>
                      <div class="font-semibold text-gray-700 mb-1">相手チーム</div>
                      <% opponent_players.each_with_index do |player, index| %>
                        <div class="<%= (opponent_team == 1 && player.position == 1) ? 'text-red-600 font-bold' : 'text-gray-600' %>">
                          <%= player.user.nickname %> / <%= player.mobile_suit.name %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              <% end %>
            <% end %>
          <% else %>
            <div class="px-6 py-8 text-center">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              <p class="mt-2 text-sm text-gray-500">まだ試合記録がありません</p>
              <p class="mt-1 text-xs text-gray-400">イベントのローテーションから試合結果を記録すると、ここに表示されます</p>
            </div>
          <% end %>
        </div>
        <% if @recent_matches.any? %>
          <div class="px-6 py-4 bg-gray-50 text-center">
            <%= link_to "すべて見る →", matches_path, class: "text-sm text-blue-600 hover:text-blue-500" %>
          </div>
        <% end %>
      </div>

      <!-- 5. 対面相性マトリクス -->
      <div class="bg-white shadow rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-gray-900">⚔️ 対面相性マトリクス</h2>
          <span class="text-xs text-gray-500" title="よく使う機体での対戦相手との相性を確認できます">ℹ️ 機体相性</span>
        </div>
        <% if @matchup_matrix.any? %>
          <div class="space-y-4">
            <% @matchup_matrix.each do |matrix| %>
              <div class="border rounded p-4">
                <div class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                  <%= matrix[:my_suit].name %>
                  <%= cost_badge(matrix[:my_suit].cost) %>
                </div>
                <div class="space-y-2">
                  <% matrix[:matchups].each do |matchup| %>
                    <div class="flex items-center justify-between text-sm bg-gray-50 rounded p-2">
                      <div class="flex-1">
                        <span class="text-gray-700"><%= matchup[:opponent_suit].name %></span>
                        <span class="text-xs text-gray-500 ml-2"><%= matchup[:wins] %>勝<%= matchup[:losses] %>敗</span>
                      </div>
                      <div class="flex items-center space-x-2">
                        <span class="font-semibold <%= matchup[:win_rate] >= 60 ? 'text-blue-600' : (matchup[:win_rate] >= 40 ? 'text-gray-600' : 'text-red-600') %>">
                          <%= matchup[:win_rate] %>%
                        </span>
                        <span class="px-2 py-1 rounded text-xs font-semibold <%= matchup[:compatibility] == '得意' ? 'bg-blue-100 text-blue-800' : (matchup[:compatibility] == '普通' ? 'bg-gray-100 text-gray-800' : 'bg-red-100 text-red-800') %>">
                          <%= matchup[:compatibility] %>
                        </span>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="text-center py-8">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            <p class="mt-2 text-sm text-gray-500">データが不足しています</p>
            <p class="mt-1 text-xs text-gray-400">同じ機体で2試合以上対戦すると、相性データが表示されます</p>
          </div>
        <% end %>
      </div>
      <% end %>

    </div>

    <!-- 右カラム（サブコンテンツ） -->
    <div class="lg:col-span-1 space-y-6">

      <!-- 1. 通知/アラート領域 -->
      <% if @notifications.any? %>
        <div class="space-y-3">
          <% @notifications.each do |notif| %>
            <div class="<%= notif[:type] == 'warning' ? 'bg-amber-50 border-amber-300' : 'bg-blue-50 border-blue-300' %> border rounded-lg p-4">
              <div class="flex items-start">
                <span class="text-2xl mr-3"><%= notif[:icon] %></span>
                <p class="text-sm <%= notif[:type] == 'warning' ? 'text-amber-800' : 'text-blue-800' %> font-medium">
                  <%= notif[:message] %>
                </p>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- 2. 個人戦績カード -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-5 border-b border-gray-200">
          <h2 class="text-lg font-bold text-gray-900">🏆 あなたの戦績</h2>
        </div>
        <% if current_user.is_guest %>
          <div class="px-6 py-8 text-center">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
            <p class="mt-2 text-sm text-gray-500">ゲストアカウントでは表示されません</p>
            <p class="mt-1 text-xs text-gray-400">管理者にアカウント発行を依頼してください</p>
          </div>
        <% else %>
        <div class="px-6 py-5">
          <div class="space-y-4">
            <div class="text-center">
              <div class="text-3xl font-bold text-blue-600"><%= @user_total_matches %></div>
              <div class="text-sm text-gray-500 mt-1">参加試合数</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-green-600"><%= @user_wins %></div>
              <div class="text-sm text-gray-500 mt-1">勝利数</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-purple-600"><%= @user_win_rate %>%</div>
              <div class="text-sm text-gray-500 mt-1">勝率</div>
            </div>
          </div>
        </div>
        <% end %>
      </div>

      <!-- 3. ベストパートナーTOP3 -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-5 border-b border-gray-200">
          <h2 class="text-lg font-bold text-gray-900">🤝 ベストパートナー</h2>
        </div>
        <div class="divide-y divide-gray-200">
          <% if current_user.is_guest %>
            <div class="px-6 py-8 text-center">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
              <p class="mt-2 text-sm text-gray-500">ゲストアカウントでは表示されません</p>
              <p class="mt-1 text-xs text-gray-400">管理者にアカウント発行を依頼してください</p>
            </div>
          <% elsif @best_partners.any? %>
            <% @best_partners.each_with_index do |partner, index| %>
              <div class="px-6 py-4">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center">
                    <span class="text-lg font-bold text-gray-400 mr-2"><%= index + 1 %></span>
                    <div>
                      <div class="font-semibold text-gray-900"><%= partner[:user].nickname %></div>
                      <div class="text-xs text-gray-500"><%= partner[:wins] %>勝<%= partner[:total] - partner[:wins] %>敗</div>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-lg font-bold text-blue-600"><%= partner[:win_rate] %>%</div>
                  </div>
                </div>
                <% if partner[:best_combo] %>
                  <div class="text-xs text-gray-600 bg-gray-50 rounded px-2 py-1 mt-2">
                    よく使う組み合わせ: <%= partner[:best_combo] %>
                  </div>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <div class="px-6 py-8 text-center">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
              <p class="mt-2 text-sm text-gray-500">まだデータがありません</p>
              <p class="mt-1 text-xs text-gray-400">同じパートナーと3試合以上プレイすると表示されます</p>
            </div>
          <% end %>
        </div>
      </div>

      <!-- 4. 機体使用トレンド（直近イベント） -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-5 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-bold text-gray-900">📱 機体トレンド</h2>
            <span class="text-xs text-gray-500" title="直近イベントでの使用機体と勝率">ℹ️ イベント別</span>
          </div>
          <% if !current_user.is_guest && @trend_event %>
            <p class="text-xs text-gray-500 mt-1">
              <%= @trend_event.name %>
              <% if @is_today_event %>
                <span class="ml-1 px-2 py-0.5 bg-blue-500 text-white rounded text-xs">開催中</span>
              <% end %>
            </p>
          <% end %>
        </div>
        <div class="divide-y divide-gray-200">
          <% if current_user.is_guest %>
            <div class="px-6 py-8 text-center">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
              <p class="mt-2 text-sm text-gray-500">ゲストアカウントでは表示されません</p>
              <p class="mt-1 text-xs text-gray-400">管理者にアカウント発行を依頼してください</p>
            </div>
          <% elsif @event_suit_trend&.any? %>
            <% @event_suit_trend.each do |trend| %>
              <div class="px-6 py-4">
                <div class="flex items-center justify-between mb-1">
                  <div class="font-medium text-gray-900"><%= trend[:mobile_suit].name %></div>
                  <div class="text-sm font-semibold <%= trend[:win_rate] >= 60 ? 'text-blue-600' : 'text-gray-600' %>">
                    <%= trend[:win_rate] %>%
                  </div>
                </div>
                <div class="text-xs text-gray-500">使用回数: <%= trend[:usage] %>回</div>
                <% if trend[:recommended] %>
                  <div class="text-xs text-blue-600 mt-1">✨ 調子が良い機体です！</div>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <div class="px-6 py-8 text-center">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
              <p class="mt-2 text-sm text-gray-500">まだ試合データがありません</p>
              <p class="mt-1 text-xs text-gray-400">イベントで試合をすると、機体の使用状況が表示されます</p>
            </div>
          <% end %>
        </div>
      </div>

      <!-- 5. コスト帯分析 -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-5 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-bold text-gray-900">💰 コスト帯分析</h2>
            <span class="text-xs text-gray-500" title="チームコストの組み合わせ別の勝率">ℹ️ コスト別</span>
          </div>
        </div>
        <div class="divide-y divide-gray-200">
          <% if current_user.is_guest %>
            <div class="px-6 py-8 text-center">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
              <p class="mt-2 text-sm text-gray-500">ゲストアカウントでは表示されません</p>
              <p class="mt-1 text-xs text-gray-400">管理者にアカウント発行を依頼してください</p>
            </div>
          <% elsif @cost_analysis.any? %>
            <% @cost_analysis.each do |cost| %>
              <div class="px-6 py-4">
                <div class="flex items-center justify-between mb-2">
                  <div>
                    <div class="font-semibold text-gray-900 flex items-center"><%= cost_combo_badges(cost[:cost_combo]) %></div>
                    <div class="text-xs text-gray-500 mt-1"><%= cost[:wins] %>勝<%= cost[:losses] %>敗</div>
                  </div>
                  <div class="text-right">
                    <div class="text-lg font-bold <%= cost[:win_rate] >= 60 ? 'text-blue-600' : (cost[:win_rate] >= 40 ? 'text-gray-600' : 'text-red-600') %>">
                      <%= cost[:win_rate] %>%
                    </div>
                    <span class="text-xs px-2 py-1 rounded <%= cost[:judgment] == '得意' ? 'bg-blue-100 text-blue-800' : (cost[:judgment] == '普通' ? 'bg-gray-100 text-gray-800' : 'bg-red-100 text-red-800') %>">
                      <%= cost[:judgment] %>
                    </span>
                  </div>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="px-6 py-8 text-center">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <p class="mt-2 text-sm text-gray-500">まだデータがありません</p>
              <p class="mt-1 text-xs text-gray-400">同じコスト組み合わせで3試合以上プレイすると表示されます</p>
            </div>
          <% end %>
        </div>
      </div>

      <!-- 6. あなたのお気に入り機体（TOP3） -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-5 border-b border-gray-200">
          <h2 class="text-lg font-bold text-gray-900">⭐ お気に入り機体</h2>
        </div>
        <div class="divide-y divide-gray-200">
          <% if current_user.is_guest %>
            <div class="px-6 py-8 text-center">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
              <p class="mt-2 text-sm text-gray-500">ゲストアカウントでは表示されません</p>
              <p class="mt-1 text-xs text-gray-400">管理者にアカウント発行を依頼してください</p>
            </div>
          <% elsif @user_favorite_suits.any? %>
            <% @user_favorite_suits.each_with_index do |suit, index| %>
              <div class="px-6 py-4 flex items-center justify-between">
                <div class="flex items-center">
                  <span class="text-lg font-bold text-gray-400 mr-3"><%= index + 1 %></span>
                  <div>
                    <div class="text-sm font-medium text-gray-900 flex items-center gap-2"><%= suit.name %> <%= cost_badge(suit.cost) %></div>
                    <div class="text-xs text-gray-500"><%= suit.series %></div>
                  </div>
                </div>
                <span class="text-sm text-purple-600 font-semibold"><%= suit.usage_count %>回</span>
              </div>
            <% end %>
          <% else %>
            <div class="px-6 py-8 text-center">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
              </svg>
              <p class="mt-2 text-sm text-gray-500">まだ試合がありません</p>
              <p class="mt-1 text-xs text-gray-400">試合に参加すると、よく使う機体が表示されます</p>
            </div>
          <% end %>
        </div>
      </div>

      <!-- 7. 今後のイベント -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-5 border-b border-gray-200">
          <h2 class="text-lg font-bold text-gray-900">📅 今後のイベント</h2>
        </div>
        <div class="divide-y divide-gray-200">
          <% if @upcoming_events.any? %>
            <% @upcoming_events.each do |event| %>
              <%= link_to event_path(event), class: "block hover:bg-gray-50 px-6 py-4" do %>
                <div class="text-sm font-medium text-gray-900"><%= event.name %></div>
                <div class="text-xs text-gray-500 mt-1"><%= event.held_on.strftime('%Y年%m月%d日') %></div>
              <% end %>
            <% end %>
          <% else %>
            <div class="px-6 py-4 text-center text-sm text-gray-500">
              予定されているイベントはありません
            </div>
          <% end %>
        </div>
        <div class="px-6 py-4 bg-gray-50 text-center">
          <%= link_to "すべて見る →", events_path, class: "text-sm text-blue-600 hover:text-blue-500" %>
        </div>
      </div>

    </div>
  </div>

  <!-- 下部全幅 - 人気の機体TOP5 -->
  <div class="mt-6">
    <div class="bg-white shadow rounded-lg">
      <div class="px-6 py-5 border-b border-gray-200">
        <h2 class="text-lg font-bold text-gray-900">🔥 人気の機体 TOP5</h2>
      </div>
      <div class="divide-y divide-gray-200">
        <% if @popular_mobile_suits.any? %>
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5">
            <% @popular_mobile_suits.each_with_index do |suit, index| %>
              <div class="px-4 sm:px-6 py-4 border-b sm:border-b-0 sm:border-r border-gray-200 last:border-b-0 last:border-r-0">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xl sm:text-2xl font-bold text-gray-300"><%= index + 1 %></span>
                  <span class="text-xs sm:text-sm text-blue-600 font-semibold"><%= suit.usage_count %>回</span>
                </div>
                <div class="text-xs sm:text-sm font-medium text-gray-900"><%= suit.name %></div>
                <div class="text-xs text-gray-500 mt-1 truncate"><%= suit.series %></div>
                <div class="mt-1"><%= cost_badge(suit.cost) %></div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="px-6 py-8 text-center">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
            </svg>
            <p class="mt-2 text-sm text-gray-500">まだ試合データがありません</p>
            <p class="mt-1 text-xs text-gray-400">試合が記録されると、人気機体のランキングが表示されます</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

</div>

<!-- Notification Script -->
<% if @active_rotation && @user_next_rotation_match && @matches_until_user_turn.present? %>
  <script>
    // Request notification permission on load
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }

    // Check if it's time to notify (0-3 matches before)
    <% if @matches_until_user_turn <= 3 && @matches_until_user_turn > 0 %>
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('出番が近づいています！', {
          body: 'あと<%= @matches_until_user_turn %>試合後です。準備してください。',
          icon: '/icon.png',
          tag: 'upcoming-match'
        });
      }
    <% elsif @matches_until_user_turn == 0 %>
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('今です！', {
          body: 'あなたの試合です。準備してください！',
          icon: '/icon.png',
          tag: 'current-match'
        });
      }
    <% end %>

    // Helper text for notification
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ダッシュボードでリアルタイム更新を受信中...');
    });
  </script>
<% end %>
