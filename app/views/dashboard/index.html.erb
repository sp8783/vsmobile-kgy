<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">ダッシュボード</h1>
    <p class="mt-2 text-sm text-gray-600">ようこそ、<%= current_user.nickname %>さん</p>
  </div>

  <!-- 2カラムレイアウト -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- 左カラム（メインコンテンツ） -->
    <div class="lg:col-span-2 space-y-6">

      <!-- 1. リアルタイム待機状況カード（開催中のイベントがある場合のみ） -->
      <% if @today_event %>
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-lg rounded-lg p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold">🎮 <%= @today_event.name %> 開催中</h2>
            <span class="bg-white text-blue-600 px-3 py-1 rounded-full text-sm font-semibold">
              <%= @event_completed_matches %>/<%= @event_total_matches %> 試合完了
            </span>
          </div>

          <% if @user_next_match %>
            <div class="bg-white bg-opacity-20 rounded-lg p-4 mb-4">
              <div class="text-sm font-semibold mb-2">⏰ あなたの出番</div>
              <div class="text-2xl font-bold mb-2">あと<%= @matches_until_user_turn %>試合</div>
              <% if @user_partner %>
                <div class="text-sm">パートナー: <%= @user_partner.nickname %></div>
              <% end %>
              <% if @opponent_players.any? %>
                <div class="text-sm mt-1">
                  対戦相手: <%= @opponent_players.map { |p| p.user.nickname }.join(' & ') %>
                </div>
              <% end %>
            </div>

            <%= link_to "この試合を記録する", new_event_match_path(@today_event), class: "block w-full bg-white text-blue-600 text-center font-semibold py-3 px-4 rounded hover:bg-gray-100 transition" %>
          <% else %>
            <div class="text-center py-4">
              <p class="text-white text-opacity-90">今日の試合には参加していません</p>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- 2. 調子メーター -->
      <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-bold text-gray-900 mb-4">📊 調子メーター</h2>

        <div class="mb-4">
          <div class="text-sm text-gray-600 mb-2">直近5試合（左：最新 → 右：古い）</div>
          <div class="flex space-x-2">
            <% @recent_5_results.each do |result| %>
              <span class="text-2xl"><%= result ? '○' : '●' %></span>
            <% end %>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <div class="text-sm text-gray-600">直近10試合勝率</div>
            <div class="text-2xl font-bold text-blue-600"><%= @recent_10_win_rate %>%</div>
            <div class="text-xs <%= @recent_10_diff >= 0 ? 'text-green-600' : 'text-red-600' %>">
              全体比 <%= @recent_10_diff >= 0 ? '+' : '' %><%= @recent_10_diff.round(1) %>%
            </div>
          </div>
          <div>
            <div class="text-sm text-gray-600">現在の連勝/連敗</div>
            <div class="text-2xl font-bold <%= @streak_type == 'win' ? 'text-green-600' : 'text-red-600' %>">
              <%= @current_streak %><%= @streak_type == 'win' ? '連勝' : '連敗' %>
            </div>
          </div>
        </div>

        <% if @streak_type == 'win' && @current_streak >= 3 %>
          <div class="bg-green-50 border border-green-200 rounded p-3 text-sm text-green-800">
            🔥 絶好調！この調子で勝ち続けましょう！
          </div>
        <% elsif @streak_type == 'lose' && @current_streak >= 3 %>
          <div class="bg-red-50 border border-red-200 rounded p-3 text-sm text-red-800">
            💪 落ち着いて！次は勝てます！
          </div>
        <% end %>
      </div>

      <!-- 3. 対戦会クイック比較 -->
      <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-bold text-gray-900 mb-4">📈 対戦会クイック比較</h2>
        <div class="space-y-3">
          <% @event_comparison.each do |ec| %>
            <div class="border rounded p-3 <%= ec[:is_today] ? 'bg-blue-50 border-blue-300' : 'border-gray-200' %>">
              <div class="flex items-center justify-between mb-2">
                <div>
                  <div class="font-semibold text-gray-900"><%= ec[:event].name %></div>
                  <div class="text-xs text-gray-500"><%= ec[:event].held_on.strftime('%Y年%m月%d日') %></div>
                </div>
                <% if ec[:is_today] %>
                  <span class="bg-blue-500 text-white px-2 py-1 rounded text-xs font-semibold">開催中</span>
                <% else %>
                  <span class="bg-gray-500 text-white px-2 py-1 rounded text-xs font-semibold">完了</span>
                <% end %>
              </div>
              <div class="flex items-center space-x-4 text-sm">
                <span class="text-gray-600">戦績: <%= ec[:wins] %>勝<%= ec[:losses] %>敗</span>
                <span class="font-semibold text-blue-600">勝率: <%= ec[:win_rate] %>%</span>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- 4. 最近の対戦（5件） -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-5 border-b border-gray-200">
          <h2 class="text-lg font-bold text-gray-900">🕐 最近の対戦</h2>
        </div>
        <div class="divide-y divide-gray-200">
          <% if @recent_matches.any? %>
            <% @recent_matches.each do |match| %>
              <%
                # ログインユーザーのチームを特定
                my_player = match.match_players.find { |mp| mp.user_id == current_user.id }
              %>
              <%= link_to match_path(match), class: "block hover:bg-gray-50 px-6 py-4" do %>
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs text-gray-500"><%= match.played_at.strftime('%Y年%m月%d日') %></span>
                  <% if my_player %>
                    <% is_win = (match.winning_team == my_player.team_number) %>
                    <span class="text-xs font-bold <%= is_win ? 'text-blue-600' : 'text-red-600' %>">
                      <%= is_win ? 'WIN' : 'LOSE' %>
                    </span>
                  <% end %>
                </div>
                <div class="text-xs text-gray-500 mb-2"><%= match.event.name %></div>

                <%
                  if my_player
                    my_team = my_player.team_number
                    opponent_team = my_team == 1 ? 2 : 1

                    my_team_players = match.match_players.select { |mp| mp.team_number == my_team }.sort_by(&:position)
                    opponent_players = match.match_players.select { |mp| mp.team_number == opponent_team }.sort_by(&:position)
                %>
                  <div class="grid grid-cols-2 gap-2 text-xs mt-2">
                    <div class="<%= match.winning_team == my_team ? 'bg-green-50 border border-green-200' : 'bg-gray-50' %> rounded p-2">
                      <div class="font-semibold text-gray-700 mb-1">自チーム</div>
                      <% my_team_players.each do |player| %>
                        <div class="text-gray-600">
                          <%= player.user.nickname %> / <%= player.mobile_suit.name %>
                        </div>
                      <% end %>
                    </div>
                    <div class="<%= match.winning_team == opponent_team ? 'bg-green-50 border border-green-200' : 'bg-gray-50' %> rounded p-2">
                      <div class="font-semibold text-gray-700 mb-1">相手チーム</div>
                      <% opponent_players.each do |player| %>
                        <div class="text-gray-600">
                          <%= player.user.nickname %> / <%= player.mobile_suit.name %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              <% end %>
            <% end %>
          <% else %>
            <div class="px-6 py-4 text-center text-sm text-gray-500">
              まだ試合記録がありません
            </div>
          <% end %>
        </div>
        <% if @recent_matches.any? %>
          <div class="px-6 py-4 bg-gray-50 text-center">
            <%= link_to "すべて見る →", matches_path, class: "text-sm text-blue-600 hover:text-blue-500" %>
          </div>
        <% end %>
      </div>

      <!-- 5. 対面相性マトリクス -->
      <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-bold text-gray-900 mb-4">⚔️ 対面相性マトリクス</h2>
        <% if @matchup_matrix.any? %>
          <div class="space-y-4">
            <% @matchup_matrix.each do |matrix| %>
              <div class="border rounded p-4">
                <div class="font-semibold text-gray-900 mb-3">
                  <%= matrix[:my_suit].name %>
                  <span class="text-xs text-gray-500">（コスト<%= matrix[:my_suit].cost %>）</span>
                </div>
                <div class="space-y-2">
                  <% matrix[:matchups].each do |matchup| %>
                    <div class="flex items-center justify-between text-sm bg-gray-50 rounded p-2">
                      <div class="flex-1">
                        <span class="text-gray-700"><%= matchup[:opponent_suit].name %></span>
                        <span class="text-xs text-gray-500 ml-2"><%= matchup[:wins] %>勝<%= matchup[:losses] %>敗</span>
                      </div>
                      <div class="flex items-center space-x-2">
                        <span class="font-semibold <%= matchup[:win_rate] >= 60 ? 'text-green-600' : (matchup[:win_rate] >= 40 ? 'text-gray-600' : 'text-red-600') %>">
                          <%= matchup[:win_rate] %>%
                        </span>
                        <span class="px-2 py-1 rounded text-xs font-semibold <%= matchup[:compatibility] == '得意' ? 'bg-green-100 text-green-800' : (matchup[:compatibility] == '普通' ? 'bg-gray-100 text-gray-800' : 'bg-red-100 text-red-800') %>">
                          <%= matchup[:compatibility] %>
                        </span>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="text-center text-sm text-gray-500 py-4">
            データが不足しています（2試合以上対戦した機体がありません）
          </div>
        <% end %>
      </div>

    </div>

    <!-- 右カラム（サブコンテンツ） -->
    <div class="lg:col-span-1 space-y-6">

      <!-- 1. 通知/アラート領域 -->
      <% if @notifications.any? %>
        <div class="space-y-3">
          <% @notifications.each do |notif| %>
            <div class="<%= notif[:type] == 'warning' ? 'bg-yellow-50 border-yellow-300' : 'bg-green-50 border-green-300' %> border rounded-lg p-4">
              <div class="flex items-start">
                <span class="text-2xl mr-3"><%= notif[:icon] %></span>
                <p class="text-sm <%= notif[:type] == 'warning' ? 'text-yellow-800' : 'text-green-800' %> font-medium">
                  <%= notif[:message] %>
                </p>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- 2. 個人戦績カード -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-5 border-b border-gray-200">
          <h2 class="text-lg font-bold text-gray-900">🏆 あなたの戦績</h2>
        </div>
        <div class="px-6 py-5">
          <div class="space-y-4">
            <div class="text-center">
              <div class="text-3xl font-bold text-blue-600"><%= @user_total_matches %></div>
              <div class="text-sm text-gray-500 mt-1">参加試合数</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-green-600"><%= @user_wins %></div>
              <div class="text-sm text-gray-500 mt-1">勝利数</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-purple-600"><%= @user_win_rate %>%</div>
              <div class="text-sm text-gray-500 mt-1">勝率</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 3. ベストパートナーTOP3 -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-5 border-b border-gray-200">
          <h2 class="text-lg font-bold text-gray-900">🤝 ベストパートナー</h2>
        </div>
        <div class="divide-y divide-gray-200">
          <% if @best_partners.any? %>
            <% @best_partners.each_with_index do |partner, index| %>
              <div class="px-6 py-4">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center">
                    <span class="text-lg font-bold text-gray-400 mr-2"><%= index + 1 %></span>
                    <div>
                      <div class="font-semibold text-gray-900"><%= partner[:user].nickname %></div>
                      <div class="text-xs text-gray-500"><%= partner[:wins] %>勝<%= partner[:total] - partner[:wins] %>敗</div>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-lg font-bold text-green-600"><%= partner[:win_rate] %>%</div>
                  </div>
                </div>
                <% if partner[:best_combo] %>
                  <div class="text-xs text-gray-600 bg-gray-50 rounded px-2 py-1 mt-2">
                    よく使う組み合わせ: <%= partner[:best_combo] %>
                  </div>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <div class="px-6 py-4 text-center text-sm text-gray-500">
              データが不足しています（3試合以上のパートナーがいません）
            </div>
          <% end %>
        </div>
      </div>

      <!-- 4. 機体使用トレンド（直近イベント） -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-5 border-b border-gray-200">
          <h2 class="text-lg font-bold text-gray-900">📱 機体トレンド</h2>
          <% if @trend_event %>
            <p class="text-xs text-gray-500 mt-1">
              <%= @trend_event.name %>
              <% if @is_today_event %>
                <span class="ml-1 px-2 py-0.5 bg-blue-500 text-white rounded text-xs">開催中</span>
              <% end %>
            </p>
          <% end %>
        </div>
        <div class="divide-y divide-gray-200">
          <% if @event_suit_trend&.any? %>
            <% @event_suit_trend.each do |trend| %>
              <div class="px-6 py-4">
                <div class="flex items-center justify-between mb-1">
                  <div class="font-medium text-gray-900"><%= trend[:mobile_suit].name %></div>
                  <div class="text-sm font-semibold <%= trend[:win_rate] >= 60 ? 'text-green-600' : 'text-gray-600' %>">
                    <%= trend[:win_rate] %>%
                  </div>
                </div>
                <div class="text-xs text-gray-500">使用回数: <%= trend[:usage] %>回</div>
                <% if trend[:recommended] %>
                  <div class="text-xs text-green-600 mt-1">✨ 調子が良い機体です！</div>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <div class="px-6 py-4 text-center text-sm text-gray-500">
              このイベントではまだ試合をしていません
            </div>
          <% end %>
        </div>
      </div>

      <!-- 5. コスト帯分析 -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-5 border-b border-gray-200">
          <h2 class="text-lg font-bold text-gray-900">💰 コスト帯分析</h2>
        </div>
        <div class="divide-y divide-gray-200">
          <% if @cost_analysis.any? %>
            <% @cost_analysis.each do |cost| %>
              <div class="px-6 py-4">
                <div class="flex items-center justify-between mb-2">
                  <div>
                    <div class="font-semibold text-gray-900"><%= cost[:cost_combo] %></div>
                    <div class="text-xs text-gray-500"><%= cost[:wins] %>勝<%= cost[:losses] %>敗</div>
                  </div>
                  <div class="text-right">
                    <div class="text-lg font-bold <%= cost[:win_rate] >= 60 ? 'text-green-600' : (cost[:win_rate] >= 40 ? 'text-gray-600' : 'text-red-600') %>">
                      <%= cost[:win_rate] %>%
                    </div>
                    <span class="text-xs px-2 py-1 rounded <%= cost[:judgment] == '得意' ? 'bg-green-100 text-green-800' : (cost[:judgment] == '普通' ? 'bg-gray-100 text-gray-800' : 'bg-red-100 text-red-800') %>">
                      <%= cost[:judgment] %>
                    </span>
                  </div>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="px-6 py-4 text-center text-sm text-gray-500">
              データが不足しています（3試合以上の組み合わせがありません）
            </div>
          <% end %>
        </div>
      </div>

      <!-- 6. あなたのお気に入り機体（TOP3） -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-5 border-b border-gray-200">
          <h2 class="text-lg font-bold text-gray-900">⭐ お気に入り機体</h2>
        </div>
        <div class="divide-y divide-gray-200">
          <% if @user_favorite_suits.any? %>
            <% @user_favorite_suits.each_with_index do |suit, index| %>
              <div class="px-6 py-4 flex items-center justify-between">
                <div class="flex items-center">
                  <span class="text-lg font-bold text-gray-400 mr-3"><%= index + 1 %></span>
                  <div>
                    <div class="text-sm font-medium text-gray-900"><%= suit.name %></div>
                    <div class="text-xs text-gray-500"><%= suit.series %> / コスト<%= suit.cost %></div>
                  </div>
                </div>
                <span class="text-sm text-purple-600 font-semibold"><%= suit.usage_count %>回</span>
              </div>
            <% end %>
          <% else %>
            <div class="px-6 py-4 text-center text-sm text-gray-500">
              まだ試合に参加していません
            </div>
          <% end %>
        </div>
      </div>

      <!-- 7. 今後のイベント -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-5 border-b border-gray-200">
          <h2 class="text-lg font-bold text-gray-900">📅 今後のイベント</h2>
        </div>
        <div class="divide-y divide-gray-200">
          <% if @upcoming_events.any? %>
            <% @upcoming_events.each do |event| %>
              <%= link_to event_path(event), class: "block hover:bg-gray-50 px-6 py-4" do %>
                <div class="text-sm font-medium text-gray-900"><%= event.name %></div>
                <div class="text-xs text-gray-500 mt-1"><%= event.held_on.strftime('%Y年%m月%d日') %></div>
              <% end %>
            <% end %>
          <% else %>
            <div class="px-6 py-4 text-center text-sm text-gray-500">
              予定されているイベントはありません
            </div>
          <% end %>
        </div>
        <div class="px-6 py-4 bg-gray-50 text-center">
          <%= link_to "すべて見る →", events_path, class: "text-sm text-blue-600 hover:text-blue-500" %>
        </div>
      </div>

      <!-- 8. クイックアクション -->
      <% if @latest_event %>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center">
          <h3 class="text-lg font-medium text-gray-900 mb-2">最新イベント</h3>
          <p class="text-sm font-semibold text-gray-700 mb-1"><%= @latest_event.name %></p>
          <p class="text-xs text-gray-600 mb-4"><%= @latest_event.held_on.strftime('%Y年%m月%d日') %></p>
          <%= link_to "対戦を記録する", new_event_match_path(@latest_event), class: "inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded" %>
        </div>
      <% end %>

    </div>
  </div>

  <!-- 下部全幅 - 人気の機体TOP5 -->
  <div class="mt-6">
    <div class="bg-white shadow rounded-lg">
      <div class="px-6 py-5 border-b border-gray-200">
        <h2 class="text-lg font-bold text-gray-900">🔥 人気の機体 TOP5</h2>
      </div>
      <div class="divide-y divide-gray-200">
        <% if @popular_mobile_suits.any? %>
          <div class="grid grid-cols-1 md:grid-cols-5 divide-y md:divide-y-0 md:divide-x divide-gray-200">
            <% @popular_mobile_suits.each_with_index do |suit, index| %>
              <div class="px-6 py-4">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-2xl font-bold text-gray-300"><%= index + 1 %></span>
                  <span class="text-sm text-blue-600 font-semibold"><%= suit.usage_count %>回</span>
                </div>
                <div class="text-sm font-medium text-gray-900"><%= suit.name %></div>
                <div class="text-xs text-gray-500 mt-1"><%= suit.series %></div>
                <div class="text-xs text-gray-500">コスト<%= suit.cost %></div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="px-6 py-4 text-center text-sm text-gray-500">
            データがありません
          </div>
        <% end %>
      </div>
    </div>
  </div>

</div>
