<%= turbo_stream_from "match_#{@match.id}_reactions" %>

<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="mb-6">
    <%= link_to "← 対戦履歴に戻る", matches_path, class: "text-blue-600 hover:text-blue-500" %>
  </div>

  <div class="bg-white shadow sm:rounded-lg">
    <div class="px-6 py-5 border-b border-gray-200">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">対戦詳細</h1>
          <div class="mt-1 flex items-center gap-2">
            <p class="text-sm text-gray-500">
              <%= @match.played_at.strftime('%Y年%m月%d日') %>
            </p>
            <% if @match.video_url %>
              <%= link_to @match.video_url, target: "_blank", rel: "noopener noreferrer", class: "inline-flex items-center gap-1 px-3 py-1 rounded-full bg-red-50 text-red-700 text-sm font-semibold hover:bg-red-100 transition-colors" do %>
                <img src="/youtube_social_icon_red.png" alt="YouTube" class="h-4">
                配信を見る
              <% end %>
            <% end %>
          </div>
        </div>
        <% if current_user.is_admin? %>
          <div class="flex flex-wrap gap-2">
            <%= link_to "編集", edit_match_path(@match), class: "bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded" %>
            <%= link_to "統計を編集", edit_match_stats_path(@match), class: "bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded" %>
            <%= button_to "削除", match_path(@match), method: :delete, data: { turbo_confirm: "この対戦記録を削除してもよろしいですか？" }, class: "bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded" %>
          </div>
        <% end %>
      </div>
    </div>

    <div class="px-6 py-5">
      <div class="mb-6">
        <h3 class="text-sm font-medium text-gray-500 mb-2">イベント</h3>
        <%= link_to @match.event.name, event_path(@match.event), class: "text-blue-600 hover:text-blue-500" %>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <% team1_players = @match.match_players.select { |p| p.team_number == 1 }.sort_by(&:position) %>
        <% team2_players = @match.match_players.select { |p| p.team_number == 2 }.sort_by(&:position) %>

        <!-- Team 1 -->
        <div class="<%= @match.winning_team == 1 ? 'bg-blue-50 border-2 border-blue-400 rounded-lg p-6' : 'bg-red-50 border-2 border-red-400 rounded-lg p-6' %>">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">チーム1</h3>
            <% if @match.winning_team == 1 %>
              <span class="px-3 py-1 bg-blue-600 text-white rounded-full text-sm font-semibold">WIN</span>
            <% else %>
              <span class="px-3 py-1 bg-red-600 text-white rounded-full text-sm font-semibold">LOSE</span>
            <% end %>
          </div>

          <div class="space-y-4">
            <% team1_players.each_with_index do |player, index| %>
              <div class="bg-white rounded-lg p-4 shadow-sm">
                <div class="flex items-start justify-between">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 flex-wrap">
                      <%= render "matches/rank_badge", rank: player.match_rank %>
                      <p class="text-lg font-semibold <%= index == 0 ? 'text-red-600' : 'text-gray-900' %>">
                        <%= player.user.nickname %>
                      </p>
                      <% if index == 0 %>
                        <span class="px-2 py-0.5 bg-red-100 text-red-700 rounded text-xs font-semibold">配信台</span>
                      <% end %>
                    </div>
                    <div class="mt-2">
                      <p class="text-sm text-gray-500">使用機体</p>
                      <p class="text-sm font-medium text-gray-900 flex items-center gap-2">
                        <%= player.mobile_suit.name %>
                        <%= cost_badge(player.mobile_suit.cost) %>
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Team 2 -->
        <div class="<%= @match.winning_team == 2 ? 'bg-blue-50 border-2 border-blue-400 rounded-lg p-6' : 'bg-red-50 border-2 border-red-400 rounded-lg p-6' %>">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">チーム2</h3>
            <% if @match.winning_team == 2 %>
              <span class="px-3 py-1 bg-blue-600 text-white rounded-full text-sm font-semibold">WIN</span>
            <% else %>
              <span class="px-3 py-1 bg-red-600 text-white rounded-full text-sm font-semibold">LOSE</span>
            <% end %>
          </div>

          <div class="space-y-4">
            <% team2_players.each do |player| %>
              <div class="bg-white rounded-lg p-4 shadow-sm">
                <div class="flex items-start justify-between">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 flex-wrap">
                      <%= render "matches/rank_badge", rank: player.match_rank %>
                      <p class="text-lg font-semibold text-gray-900"><%= player.user.nickname %></p>
                    </div>
                    <div class="mt-2">
                      <p class="text-sm text-gray-500">使用機体</p>
                      <p class="text-sm font-medium text-gray-900 flex items-center gap-2">
                        <%= player.mobile_suit.name %>
                        <%= cost_badge(player.mobile_suit.cost) %>
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- 対戦統計セクション -->
      <% all_players = team1_players + team2_players %>
      <% has_stats = all_players.any?(&:has_stats?) || !@match.team1_ex_overlimit_before_end.nil? || !@match.team2_ex_overlimit_before_end.nil? %>
      <% if has_stats %>
        <div class="mt-8">
          <h2 class="text-lg font-bold text-gray-900 mb-4">対戦統計</h2>

          <% [[team1_players, 1], [team2_players, 2]].each do |players, team_num| %>
            <% is_winner = @match.winning_team == team_num %>
            <div class="mb-6">
              <h3 class="text-sm font-semibold text-gray-600 mb-2">
                チーム<%= team_num %>
                <% if is_winner %>
                  <span class="ml-1 text-blue-600">WIN</span>
                <% else %>
                  <span class="ml-1 text-red-600">LOSE</span>
                <% end %>
              </h3>
              <div class="overflow-x-auto">
                <table class="min-w-full text-sm border border-gray-200 rounded-lg overflow-hidden">
                  <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                    <tr>
                      <th class="px-3 py-2 text-left">プレイヤー</th>
                      <th class="px-3 py-2 text-right">スコア</th>
                      <th class="px-3 py-2 text-right">撃墜</th>
                      <th class="px-3 py-2 text-right">被撃墜</th>
                      <th class="px-3 py-2 text-right">与ダメージ</th>
                      <th class="px-3 py-2 text-right">被ダメージ</th>
                      <th class="px-3 py-2 text-right">EXバーストダメージ</th>
                      <th class="px-3 py-2 text-right">EXバースト回数</th>
                      <th class="px-3 py-2 text-right">EXバースト中被撃墜</th>
                      <th class="px-3 py-2 text-right <%= is_winner ? 'text-gray-300' : '' %>">EXバースト残し</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-100">
                    <% players.each do |player| %>
                      <tr class="bg-white hover:bg-gray-50">
                        <td class="px-3 py-2 font-medium text-gray-900 whitespace-nowrap">
                          <div class="flex items-center gap-2">
                            <%= render "matches/rank_badge", rank: player.match_rank %>
                            <%= player.user.nickname %>
                          </div>
                        </td>
                        <td class="px-3 py-2 text-right text-gray-700"><%= number_with_delimiter(player.score) if player.score %></td>
                        <td class="px-3 py-2 text-right text-gray-700"><%= player.kills %></td>
                        <td class="px-3 py-2 text-right text-gray-700"><%= player.deaths %></td>
                        <td class="px-3 py-2 text-right text-gray-700"><%= number_with_delimiter(player.damage_dealt) if player.damage_dealt %></td>
                        <td class="px-3 py-2 text-right text-gray-700"><%= number_with_delimiter(player.damage_received) if player.damage_received %></td>
                        <td class="px-3 py-2 text-right text-gray-700"><%= number_with_delimiter(player.exburst_damage) if player.exburst_damage %></td>
                        <td class="px-3 py-2 text-right text-gray-700"><%= player.exburst_count %></td>
                        <td class="px-3 py-2 text-right text-gray-700"><%= player.exburst_deaths %></td>
                        <td class="px-3 py-2 text-right">
                          <% if is_winner %>
                            <span class="text-gray-300">―</span>
                          <% elsif player.last_death_ex_available || player.survive_loss_ex_available %>
                            <span class="px-1.5 py-0.5 rounded bg-red-100 text-red-700 text-xs font-semibold">あり</span>
                          <% elsif player.last_death_ex_available == false || player.survive_loss_ex_available == false %>
                            <span class="text-gray-500">なし</span>
                          <% else %>
                            <span class="text-gray-300">―</span>
                          <% end %>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>

              <% unless is_winner %>
                <p class="mt-1 text-xs text-gray-400">※ EXバースト残し: 敗北チームのみ・EXバーストを持ったまま敗戦</p>
              <% end %>
              <% ol_flag = team_num == 1 ? @match.team1_ex_overlimit_before_end : @match.team2_ex_overlimit_before_end %>
              <% unless ol_flag.nil? %>
                <div class="mt-2 flex items-center gap-2 text-xs">
                  <span class="text-gray-400">EXオーバーリミット:</span>
                  <% if ol_flag %>
                    <%# ol_flag=true = OL未発動（exbst-ovイベントなし） %>
                    <% if is_winner %>
                      <span class="px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 font-semibold">OL未発動で勝利</span>
                    <% else %>
                      <span class="px-2 py-0.5 rounded-full bg-red-100 text-red-700 font-semibold">OL未発動で敗北</span>
                    <% end %>
                  <% else %>
                    <%# ol_flag=false = OL発動あり %>
                    <span class="px-2 py-0.5 rounded-full bg-gray-100 text-gray-500 font-semibold">OL発動あり</span>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- タイムラインセクション -->
      <% if @match.match_timeline %>
        <%
          _raw          = @match.match_timeline.timeline_raw
          _player_order = _raw["_player_order"]
          # _player_order: { "team1" => ["ぱぴこ", "りーん"], "team2" => ["ラソ", "まき神"] }
          # ワークフロー JSON から保存時に生成。グループキーの配列インデックスと対応。

          if _player_order
            # ニックネームで DB の match_player と突合し、正しい team_number・position を取得
            _name_to_mp = @match.match_players.each_with_object({}) { |mp, h| h[mp.user.nickname] = mp }

            # グループキー → match_player のマッピング
            _key_to_mp = {}
            (_player_order["team1"] || []).each_with_index { |name, i| mp = _name_to_mp[name]; _key_to_mp["team1-#{i + 1}"] = mp if mp }
            (_player_order["team2"] || []).each_with_index { |name, i| mp = _name_to_mp[name]; _key_to_mp["team2-#{i + 1}"] = mp if mp }

            # group_order: DB team_number → DB position 昇順（統計表・チームカードと同じ並び）
            _group_order = _key_to_mp.keys.sort_by { |k| mp = _key_to_mp[k]; mp ? [mp.team_number, mp.position] : [99, 99] }

            # team_info: グループキー → DB team_number（JS のチームカラー・セパレーター判定用）
            _team_info = _key_to_mp.transform_values(&:team_number)

            _winner_keys = _group_order.select { |k| _team_info[k] == @match.winning_team }
            _timeline_data = _raw.merge("group_order" => _group_order, "team_info" => _team_info, "winner_keys" => _winner_keys)
          else
            # 規約フォールバック: team1-1 = team1 の position が小さい方（配信台）
            _group_order = (
              team1_players.each_with_index.map { |_, i| "team1-#{i + 1}" } +
              team2_players.each_with_index.map { |_, i| "team2-#{i + 1}" }
            )
            _winner_prefix = "team#{@match.winning_team}-"
            _winner_keys = _group_order.select { |k| k.start_with?(_winner_prefix) }
            _timeline_data = _raw.merge("group_order" => _group_order, "winner_keys" => _winner_keys)
          end
        %>
        <div class="mt-8">
          <h2 class="text-lg font-bold text-gray-900 mb-4">タイムライン</h2>
          <div class="overflow-x-auto rounded-xl shadow-md bg-indigo-50 p-4"
               data-controller="match-timeline"
               data-match-timeline-json-value="<%= _timeline_data.to_json %>">
          </div>
          <div class="mt-2 text-xs text-gray-500 space-y-2">
            <div>
              <span class="font-semibold text-gray-400">上段 — EXバースト系</span>
              <div class="mt-1 flex flex-wrap gap-x-4 gap-y-1">
                <span class="flex items-center gap-1"><span class="inline-block w-4 rounded" style="height:8px;background:#C7D2FE"></span>EXバースト発動可能域</span>
                <span class="flex items-center gap-1"><span class="inline-block w-4 rounded" style="height:8px;background:#F97316"></span>ファイティングバースト</span>
                <span class="flex items-center gap-1"><span class="inline-block w-4 rounded" style="height:8px;background:#3B82F6"></span>シューティングバースト</span>
                <span class="flex items-center gap-1"><span class="inline-block w-4 rounded" style="height:8px;background:#22C55E"></span>エクステンドバースト</span>
                <span class="flex items-center gap-1"><span class="inline-block rounded" style="width:20px;height:14px;background:#EDE9FE"></span>EXバーストクロス</span>
              </div>
            </div>
            <div>
              <span class="font-semibold text-purple-600">下段 — EXオーバーリミット系</span>
              <div class="mt-1 flex flex-wrap gap-x-4 gap-y-1">
                <span class="flex items-center gap-1"><span class="inline-block w-4 rounded" style="height:6px;background:#DDD6FE"></span>EXオーバーリミット発動可能域</span>
                <span class="flex items-center gap-1"><span class="inline-block w-4 rounded" style="height:6px;background:#8B5CF6"></span>EXオーバーリミット発動中</span>
              </div>
            </div>
            <div>
              <span class="font-semibold text-red-500">マーカー</span>
              <div class="mt-1 flex flex-wrap gap-x-4 gap-y-1">
                <span class="flex items-center gap-1"><span class="font-black text-red-500" style="font-size:14px;line-height:1">✕</span>被撃墜</span>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <!-- リアクションバー -->
      <%= render "reactions/reaction_bar", match: @match %>
    </div>
  </div>
</div>
